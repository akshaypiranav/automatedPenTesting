import React from 'react';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { faDownload, faEye } from '@fortawesome/free-solid-svg-icons';
import { Card, CardBody } from 'react-bootstrap';

const PenetrationTestingTable = ({ testItems }) => {
  // function to handle the download
  const handleDownload = (reportUrl, isPreview) => {
    const filename = reportUrl.split('/').pop();
    const endpoint = isPreview ? 'fetch-pdf' : 'download-pdf';

    const url = `http://127.0.0.1:8000/${endpoint}/${encodeURIComponent(filename)}/`;
    
    // If it's a preview, open in a new tab, else download
    if (isPreview) {
        window.open(url, '_blank');
    } else {
        // Trigger the download by creating an anchor element
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
  };

  // Sort testItems in descending order based on their index
  const sortedTestItems = testItems.slice().sort((a, b) => b.index - a.index);

  return (
    <Card className='scancard'>
      <CardBody className='scancard p-4 shadow '>
        <div>
          <h2>Recent Scans</h2>

          <table className="table table-dark table-hover">
            <thead>
              <tr>
                <th>S/no</th>
                <th>Target(s)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {/* using the map function to render the values */}
              {sortedTestItems.reverse().map((item, index) => (
                <tr key={index}>
                  <td>{index + 1}</td>
                  <td>{item.link}</td>
                  <td>{item.status}</td>
                  <td>
                    {/* eye icon for preview if reportUrl exists */}
                    {item.result === 'Completed' && item.reportUrl && (
                      <FontAwesomeIcon
                        icon={faEye}
                        className="preview-icon me-4"
                        onClick={() => handleDownload(item.reportUrl, true)}
                        style={{ cursor: 'pointer' }}
                      />
                    )}
                    {/* download icon if reportUrl exists */}
                    {item.result === 'Completed' && item.reportUrl && (
                      <FontAwesomeIcon
                        icon={faDownload}
                        className="download-icon"
                        onClick={() => handleDownload(item.reportUrl, false)}
                        style={{ cursor: 'pointer' }}
                      />
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </CardBody>
    </Card>
  );
};

export default PenetrationTestingTable;
